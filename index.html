<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>グラブル待機ルーム</title>
	<link href="umi/css/bootstrap.min.css" rel="stylesheet">
	<style type="text/css">
	<!--
	body{
		line-height:1.5;
		padding:120px 10px;
		background-image:url(sky.jpg);
		background-position:center center;
		background-repeat:no-repeat;
		background-attachment:fixed;
		background-size:cover;
		background-color:#add8e6;
	}
	li.chat{
		background:#ffffff;
		margin-bottom:5px;
		list-style:none;
		padding:10px;
		position:relative;
		border-radius:10px;
		-webkit-border-radius:10px;
		-moz-border-radius:10px;
	}
	li.pat0{
		color:#800000;
	}
	li.pat1{
		color:#000080;
	}
	li.pat2{
	}
	li.pat3{
		font-weight:bold;
	}
	li.pat3:hover{
		background:#ffff00;
	}
	li.pat4{
		color:#008000;
	}
	li.pat5{
		background:#000000;
		color:#ffffff;
	}
	li.pat6{
		background:#000000;
		color:#ffff00;
	}
	div.modalbox{
		opacity:0;
	}
	div.ank{
		padding-top:10%;
	}
	button.ankbutton{
		height:80px;
	}
	textarea{
		position:fixed;
	}
	//-->
	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>

<body>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header col-md-4">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<form class="navbar-form navbar-left col-xs-10 col-md-12">
					<div class="form-group col-xs-9">
						<input type="text" class="form-control text" id="msg_box" autocomplete="off" placeholder="例)ANAKIN">
					</div>
					<button type="submit" class="btn btn-default push col-xs-3" id="msg_button" onClick="pushMessage('');return false;">送信</button>
				</form>
				<div class="nav navbar-nav navbar-form dealpass">
					<button type="button" class="btn btn-info col-xs-4 col-md-6" onClick="pushMessage('deal');">Deal</a>
					<button type="button" class="btn btn-danger col-xs-4 col-md-6" onClick="pushMessage('pass');">Pass</a>
				</div>
			</div>
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="navbar-text" id="user"></li>
					<li class="navbar-text" id="info"></li>
					<li class="dropdown">
						<a href="" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Member <span class="caret"></span></a>
						<ul class="dropdown-menu" id=member></ul>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="javascript:document.location.reload();"><span class="glyphicon glyphicon-remove"></span></a></li>
				</ul>
			</div>
		</div>
	</nav>
	<div id="alert"></div>
	<div id="log">
		<ul class="chatlist">
			<li class="chat">グラブル待機ルームへようこそ！</li>
			<li class="chat">まずはきくうしさまの名前を登録しよう</li>
		</ul>
	</div>
	<div class="modal fade" id="ankmodal" tabindex="-1">
		<div class="modal-dialog modal-lg ank">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">アンケート</h4>
				</div>
				<div class="modal-body"></div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
	
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		var socketio = io.connect(location.href);
		//コールバック
		socketio.on("connected", function(name){});
		socketio.on("set", function(data){countFamily(data.num, data.max, data.mem, data.dnum, data.dmem);});
		socketio.on("push", function(data){addMessage(data.val, data.name, data.mes);});
		socketio.on("name", function(data){setName(data.name)});
		socketio.on("deal", function(data){appearButton(data.val)});
		socketio.on("ank", function(data){appearModal(data.val)});
		socketio.on("return", function(data){socketio.emit("auto", data);});
		socketio.on("disconnect", function(){});
		
		//送信部
		var first_push = false;
		function pushMessage(text){
			if(text == ""){
				text = $('#msg_box').val();
				if(text == "")return;
			}
			socketio.emit(first_push?"push":"connected", text);
			$('#msg_box').val('');
		}
		
		//受信部
		function countFamily(num, max, mem, dnum, dmem){
			$('li#info').empty();
			var text = '<span class="glyphicon glyphicon-home"></span>' + num + '/' + max;
			if(dnum > 0){
				text += ' <span class="glyphicon glyphicon-ok-circle"></span>' + Object.keys(dmem).length + '/' + dnum;
			}
			$('li#info').append(text);
			$('ul#member').empty();
			for(key in mem){
				if(dnum > 0){
					text = '<li><a href="" onClick="return false;"><span class="label label-' + (dmem[key] ? 'success">deal</span>' : 'default">no deal</span>') + mem[key] + '</a></li>';
				}else{
					text = '<li><a href="" onClick="return false;">' + mem[key] + '</a></li>';
				}
				$('ul#member').append(text);
			}
		}
		
		function setName(name){
			first_push = true;
			$('#msg_box').attr('placeholder', '例)12345678 つよばはHL');
			var text = 'きくうしさまは <strong>'+name+'</strong> なの。'
			$('li#user').html(text);
		}
		
		function appearButton(val){
			if(val){
				$('.dealpass').css({
					display:""
				});
			}else{
				$('.dealpass').css({
					display:"none"
				});
			}
		}
		
		function appearModal(val){
			if(val){
				$('#ankmodal').on('shown.bs.modal', function(event){
					$(this).empty();
					var obj = $('<div class="container"><div class="row"><button class="btn btn-default btn-lg btn-block ankbutton col-md-6">Block level button</button><button class="btn btn-default btn-lg btn-block ankbutton col-md-6">Block level button</button></div></div>');
					$(this).append(obj);
				});
				$('#ankmodal').modal({
					keyboard:false,
					backdrop:"static"
				});
			}else{
				$('#ankmodal').modal('hide');
			}
		}
		
		function addMessage(num, name, mes){
			var obj = $('<li class="' + 'chat pat' + num + '"/>')
				.css({
					right:'40px',
					opacity:0
				});
			var text = '[' + new Date().toLocaleTimeString() + '] ' + mes;
			if(name !== void 0){
				text += " by " + name;
			}
			if(num == 3){
				obj.attr('data-room', mes);
				obj.attr('onClick', 'copyList(this);');
			}
			obj.html(text);
			$('ul.chatlist').prepend(obj);
			obj.animate({
				right:'0',
				opacity:1
			}, 700);
		}
		
		//クリップボードコピー
		function copyList(obj){
			//コピー処理
			var copyFrom = $('<textarea>');
			copyFrom.val(obj.dataset.room);
			$('body').append(copyFrom);
			copyFrom.select();
			document.execCommand('copy');
			copyFrom.remove();
			//アラート処理
			var modal = $('<div class="alert alert-dismissible alert-success modalbox"><button type="button" class="close" data-dismiss="alert">×</button>ファクシミリしました。</div>');
			$('div#alert').append(modal);
			slideIn().then(slideOut);
		}
		
		//モーダルスライド
		function slideIn(){
			var d = new $.Deferred;
			var modal = $('div.modalbox');
			modal.animate({
				opacity:1
			}, 700, function(){
				d.resolve();
			});
			return d.promise();
		}
		
		function slideOut(){
			var d = new $.Deferred;
			var modal = $('div.modalbox');
			modal.delay(2000)
				.animate({
				opacity:0
			}, 700, function(){
				modal.remove();
				d.resolve();
			});
			return d.promise();
		}
		
		//ページ表示時
		$(function(){
			countFamily(0, 0, 0, 0, 0);
			$('li.chat')
				.css({
					right:'40px',
					opacity:0
				})
				.each(function(i){
					$(this).delay(300*i).animate({
						right:'0',
						opacity:1
					}, 700);
				});
			appearButton(false);
		});
	</script>
	<script src="umi/js/bootstrap.min.js"></script>
</body>

</html>