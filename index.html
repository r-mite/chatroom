<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>グラブル待機ルーム</title>
	<link href="umi/css/bootstrap.min.css" rel="stylesheet">
	<style type="text/css">
	<!--
	body{
		background:#add8e6;
		line-height:1.5;
	    padding:120px 10px;
	}
	li.chat{
		background:#ffffff;
		margin-bottom:5px;
		list-style:none;
		padding:10px;
		position:relative;
		border-radius:10px;
		-webkit-border-radius:10px;
		-moz-border-radius:10px;
	}
	li.pat0{
		color:#800000;
	}
	li.pat1{
		color:#000080;
	}
	li.pat2{
	}
	li.pat3{
		font-weight:bold;
	}
	li.pat3:hover{
		background:#ffff00;
	}
	li.pat4{
		color:#008000;
	}
	li.pat5{
		background:#000000;
		color:#ffffff;
	}
	li.pat6{
		background:#000000;
		color:#ffff00;
	}
	div#front{
		position:fixed;
		z-index:998;
		background:#add8e6;
		width:100%;
		top:-10px;
		padding:20px 0 10px 0;
	}
	div#member{
		overflow: hidden;
		margin-right: 10px;
		zoom:1;
	}
	div#member:before,
	div#member:after{
		content:"";
		display:table;
	}
	div#member:after{
		clear:both;
	}
	div.mem{
		float:left;
		background:#e9967a;
		margin:1px;
		padding:5px 10px;
		border-radius:10px;
		-webkit-border-radius:10px;
		-moz-border-radius:10px;
	}
	div.dmem{
		float:left;
		background:#808080;
		margin:1px;
		padding:5px 10px;
		border-radius:10px;
		-webkit-border-radius:10px;
		-moz-border-radius:10px;
	}
	div#modal{
		position:fixed;
		z-index:999;
		top:-50px;
		left:50%;
		margin-left:-100px;
		opacity:0;
		background:#ffdead;
		padding:10px 30px;
		border-radius:10px;
		-webkit-border-radius:10px;
		-moz-border-radius:10px;
		box-shadow: 2px 2px 3px 1px #666;
		-moz-box-shadow: 2px 2px 3px 1px #666;
		-webkit-box-shadow: 2px 2px 3px 1px #666;
	}
	textarea{
		position:fixed;
	}
	//-->
	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>

<body>
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header col-md-4">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<form class="navbar-form navbar-left col-xs-10 col-md-12">
					<div class="form-group col-xs-9">
						<input type="text" class="form-control text" id="msg_box" autocomplete="off" placeholder="例)ANAKIN">
					</div>
					<button type="submit" class="btn btn-default push col-xs-3" id="msg_button" onClick="pushMessage('');return false;">送信</button>
				</form>
				<div class="nav navbar-nav nabvar-form dealpass">
					<button type="button" class="btn btn-info col-xs-4 col-md-6" onClick="pushMessage('deal');">Deal</a>
					<button type="button" class="btn btn-danger col-xs-4 col-md-6" onClick="pushMessage('pass');">Pass</a>
				</div>
			</div>
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="navbar-text" id="user"></li>
					<li class="navbar-text" id="info"></li>
					<li class="dropdown">
						<a href="" class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Member <span class="caret"></span></a>
						<ul class="dropdown-menu" id=member></ul>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="#">Link</a></li>
				</ul>
			</div>
		</div>
	</nav>
          <!--
	<div id="front">
		<div id="user"></div>
		<div id="info"></div>
		
		<form name="push" action="" onsubmit="return false;">
			<input type="text" class="text" id="msg_box" autocomplete="off" />
			<input type="submit" class="push" id="msg_button" value="登録" onClick="pushMessage('');return false;" />
		</form>
		
		<form name="deal" action="" onsubmit="return false;">
			<input type="submit" class="deal" value="ディール" onClick="pushMessage('deal');return false;" />
			<input type="submit" class="pass" value="パスする" onClick="pushMessage('pass');return false;" />
		</form>
		
		<div id="member"></div>
	</div>
	-->
	<div id="log">
		<ul class="chatlist">
			<li class="chat">グラブル待機ルームへようこそ！</li>
			<li class="chat">まずはきくうしさまの名前を登録しよう</li>
		</ul>
	</div>
	
	<script src="/socket.io/socket.io.js"></script>
	<script type="text/javascript">
		var socketio = io.connect(location.href);
		//コールバック
		socketio.on("connected", function(name){});
		socketio.on("set", function(data){countFamily(data.num, data.max, data.mem, data.dnum, data.dmem);});
		socketio.on("push", function(data){addMessage(data.val, data.name, data.mes);});
		socketio.on("name", function(data){setName(data.name)});
		socketio.on("deal", function(data){appearButton(data.val)});
		socketio.on("return", function(data){socketio.emit("auto", data);});
		socketio.on("disconnect", function(){});
		
		//送信部
		var first_push = false;
		function pushMessage(text){
			if(text == ""){
				text = $('#msg_box').val();
				if(text == "")return;
			}
			socketio.emit(first_push?"push":"connected", text);
			$('#msg_box').val('');
		}
		
		//受信部
		function countFamily(num, max, mem, dnum, dmem){
			$('li#info').empty();
			var text = '<span class="glyphicon glyphicon-home"></span>' + num + '/' + max;
			if(dnum > 0){
				text += ' <span class="glyphicon glyphicon-ok-circle"></span>' + Object.keys(dmem).length + '/' + dnum;
			}
			$('li#info').append(text);
			$('ul#member').empty();
			for(key in mem){
				if(dnum > 0){
					text = '<li><a href="" onClick="return false;"><span class="label label-' + (dmem[key] ? 'success">deal</span>' : 'default">no deal</span>') + mem[key] + '</a></li>';
				}else{
					text = '<li><a href="" onClick="return false;">' + mem[key] + '</a></li>';
				}
				$('ul#member').append(text);
			}
		}
		
		function setName(name){
			first_push = true;
			$('#msg_box').attr('placeholder', '例)12345678 つよばはHL');
			var text = 'きくうしさまは <strong>'+name+'</strong> なの。'
			$('li#user').html(text);
		}
		
		function appearButton(val){
			if(val){
				$('.dealpass').css({
					display:""
				});
			}else{
				$('.dealpass').css({
					display:"none"
				});
			}
		}
		
		function addMessage(num, name, mes){
			var obj = $('<li class="' + 'chat pat' + num + '"/>')
				.css({
					right:'40px',
					opacity:0
				});
			var text = '[' + new Date().toLocaleTimeString() + '] ' + mes;
			if(name !== void 0){
				text += " by " + name;
			}
			if(num == 3){
				obj.attr('data-room', mes);
				obj.attr('onClick', 'copyList(this);');
			}
			obj.html(text);
			$('ul.chatlist').prepend(obj);
			obj.animate({
				right:'0',
				opacity:1
			}, 700);
		}
		
		//クリップボードコピー
		function copyList(obj){
			//コピー処理
			var copyFrom = $('<textarea>');
			copyFrom.val(obj.dataset.room);
			$('body').append(copyFrom);
			copyFrom.select();
			document.execCommand('copy');
			copyFrom.remove();
			//モーダル処理
			var modal = $('<div id="modal">');
			modal.html("ファクシミリしました。");
			$('body').append(modal);
			slideIn().then(slideOut);
		}
		
		//モーダルスライド
		function slideIn(){
			var d = new $.Deferred;
			var modal = $('div#modal');
			modal.animate({
				top:'20px',
				opacity:1
			}, 700, function(){
				d.resolve();
			});
			return d.promise();
		}
		
		function slideOut(){
			var d = new $.Deferred;
			var modal = $('div#modal');
			modal.delay(2000)
				.animate({
				top:'-70px',
				opacity:0
			}, 700, function(){
				modal.remove();
				d.resolve();
			});
			return d.promise();
		}
		
		//ページ表示時
		$(function(){
			countFamily(0, 0, 0, 0, 0);
			$('li.chat')
				.css({
					right:'40px',
					opacity:0
				})
				.each(function(i){
					$(this).delay(300*i).animate({
						right:'0',
						opacity:1
					}, 700);
				});
			appearButton(false);
		});
	</script>
	<script src="umi/js/bootstrap.min.js"></script>
</body>

</html>